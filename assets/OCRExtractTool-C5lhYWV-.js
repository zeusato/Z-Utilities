import{r as l,j as s}from"./index-DKdO3KDO.js";import"./_commonjsHelpers-Cpj98o6Y.js";const dt="K84672286188957",z="rounded-2xl border border-zinc-200/80 bg-white/70 shadow-sm backdrop-blur dark:bg-zinc-900/60 dark:border-zinc-700";function ht(u){return new Promise((v,f)=>{const x=new FileReader;x.onload=w=>v(String(w.target?.result||"")),x.onerror=f,x.readAsDataURL(u)})}async function ut(u,v=1024){return new Promise(f=>{const x=new Image;x.onload=()=>{const w=document.createElement("canvas"),j=w.getContext("2d");let{width:E,height:P}=x;w.width=E,w.height=P,j.drawImage(x,0,0,E,P);let C=.9,M=w.toDataURL("image/jpeg",C);const X=D=>D.split(",")[1].length*3/4/1024;for(;X(M)>v&&C>.15;)C-=.1,M=w.toDataURL("image/jpeg",C);f(M)},x.src=u})}function pt(){const[u,v]=l.useState([]),[f,x]=l.useState(-1),[w,j]=l.useState(""),[E,P]=l.useState(!0),[C,M]=l.useState(!1),[X,D]=l.useState(""),[R,O]=l.useState(!1),[L,U]=l.useState(1),[W,N]=l.useState({x:0,y:0}),[Y,K]=l.useState(1),[T,_]=l.useState({x:0,y:0}),[Q,I]=l.useState(!1),[B,Z]=l.useState({width:0,height:0}),F=l.useRef({x:0,y:0}),q=l.useRef(null),m=l.useRef(null),A=l.useRef(null),g=l.useRef(null),H=l.useRef(null),$=f>=0&&f<u.length,y=$?u[f]:null;l.useEffect(()=>{if(!window.pdfjsLib){const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.onload=()=>{window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"},document.head.appendChild(t)}},[]),l.useEffect(()=>{if(!y||!m.current){K(1),_({x:0,y:0}),U(1),N({x:0,y:0}),Z({width:0,height:0});return}const t=()=>{const e=m.current,r=e.clientWidth,n=e.clientHeight;if(r===0||n===0)return;const o=new Image;o.onload=()=>{const a=o.naturalWidth,c=o.naturalHeight;Z({width:a,height:c});const h=r/a,p=n/c,i=Math.min(h,p,1),d=a*i,b=c*i,k=(r-d)/2,S=(n-b)/2;K(i),_({x:k,y:S}),U(i),N({x:k,y:S})},o.src=y.dataUrl};t(),m.current&&(m.current.clientWidth===0||m.current.clientHeight===0)&&setTimeout(t,0)},[y]);const V=l.useCallback(async t=>{if(!t||!t.length)return;const e=[];for(const r of Array.from(t))if(r.type==="application/pdf"){const n=window.pdfjsLib;if(!n)continue;const o=await r.arrayBuffer(),a=await n.getDocument({data:o}).promise,c=Math.min(a.numPages,Math.max(0,5-(u.length+e.length)));for(let h=1;h<=c;h++){const p=await a.getPage(h),i=p.getViewport({scale:1.5}),d=document.createElement("canvas"),b=d.getContext("2d");d.width=i.width,d.height=i.height,await p.render({canvasContext:b,viewport:i}).promise,e.push({id:`${Date.now()}-${h}`,dataUrl:d.toDataURL("image/jpeg"),name:`${r.name}#${h}`})}}else["image/jpeg","image/png","image/webp"].includes(r.type)&&e.push({id:`${Date.now()}-${Math.random()}`,dataUrl:await ht(r),name:r.name});if(u.length+e.length>5){j("❌ Tối đa 5 trang/ảnh.");return}j(""),v(r=>{const n=[...r,...e];return n.length&&f===-1&&x(0),n})},[u.length,f]),tt=()=>{v([]),x(-1),D(""),j(""),O(!1),U(1),g.current&&(g.current.style.left="",g.current.style.top="",g.current.style.width="",g.current.style.height="")},et=()=>{if(!m.current||!g.current)return;const t=m.current.getBoundingClientRect(),e=Math.max(80,Math.floor(t.width*.6)),r=Math.max(60,Math.floor(t.height*.5)),n=Math.floor((t.width-e)/2),o=Math.floor((t.height-r)/2);g.current.style.width=e+"px",g.current.style.height=r+"px",g.current.style.left=n+"px",g.current.style.top=o+"px"},nt=()=>{O(!0),setTimeout(()=>et(),0)},st=()=>{if(!y||!g.current||!m.current||!A.current)return;const e=A.current.getBoundingClientRect();m.current.getBoundingClientRect();const r=g.current.getBoundingClientRect(),n=Math.max(0,r.left-e.left),o=Math.max(0,r.top-e.top),a=Math.min(e.width-n,r.width),c=Math.min(e.height-o,r.height),h=new Image;h.onload=()=>{const p=h.naturalWidth/e.width,i=h.naturalHeight/e.height,d=document.createElement("canvas"),b=d.getContext("2d");d.width=Math.max(1,Math.floor(a*p)),d.height=Math.max(1,Math.floor(c*i)),b.drawImage(h,n*p,o*i,a*p,c*i,0,0,d.width,d.height);const k=d.toDataURL("image/jpeg");v(S=>S.map((J,lt)=>lt===f?{...J,dataUrl:k}:J)),O(!1)},h.src=y.dataUrl};l.useEffect(()=>{if(!R||!g.current||!m.current)return;const t=g.current,e=m.current,r=a=>{const p=a.target.dataset.role==="resize"?"resize":"move",i=t.getBoundingClientRect();H.current={mode:p,startX:a.clientX,startY:a.clientY,boxStart:{left:i.left,top:i.top,width:i.width,height:i.height}},a.preventDefault(),a.stopPropagation()},n=a=>{if(!H.current)return;const c=H.current,h=a.clientX-c.startX,p=a.clientY-c.startY,i=e.getBoundingClientRect();if(c.mode==="move"){let d=c.boxStart.left+h-i.left,b=c.boxStart.top+p-i.top;d=Math.max(0,Math.min(d,i.width-c.boxStart.width)),b=Math.max(0,Math.min(b,i.height-c.boxStart.height)),t.style.left=d+"px",t.style.top=b+"px"}else{let d=Math.max(40,c.boxStart.width+h),b=Math.max(40,c.boxStart.height+p);const k=parseFloat(t.style.left||"0"),S=parseFloat(t.style.top||"0");d=Math.min(d,i.width-k),b=Math.min(b,i.height-S),t.style.width=d+"px",t.style.height=b+"px"}},o=()=>H.current=null;return t.addEventListener("mousedown",r),document.addEventListener("mousemove",n),document.addEventListener("mouseup",o),()=>{t.removeEventListener("mousedown",r),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o)}},[R]),l.useEffect(()=>{if(!B.width||L<=Y){N(T);return}const t=m.current?m.current.clientWidth:0,e=m.current?m.current.clientHeight:0,r=B.width*L,n=B.height*L,o=0,a=t-r,c=0,h=e-n;N(p=>({x:Math.min(o,Math.max(a,p.x)),y:Math.min(c,Math.max(h,p.y))}))},[L,B,T]);const rt=()=>{U(Y),N(T)},at=()=>{O(!1)},ot=t=>{if(!$)return;t.preventDefault();const e=-t.deltaY;U(r=>{const n=Math.max(Y,Math.min(4,r+(e>0?.1:-.1)));return Number(n.toFixed(2))})},G=async t=>{try{const e=E?await ut(t.dataUrl,1024):t.dataUrl,r=await(await fetch(e)).blob(),n=new FormData;n.append("language","eng"),n.append("isOverlayRequired","false"),n.append("apikey",dt),n.append("OCREngine","2"),n.append("file",r,t.name||"image.jpg");const o=await fetch("https://api.ocr.space/parse/image",{method:"POST",body:n});if(!o.ok)throw new Error(`HTTP ${o.status}`);const a=await o.json();if(a.IsErroredOnProcessing)throw new Error(a.ErrorMessage||"OCR error");return a?.ParsedResults?.[0]?.ParsedText||""}catch(e){return j("❌ Lỗi OCR: "+(e?.message||"Không xác định")),null}},ct=async()=>{if(!y)return;M(!0),j("");const t=await G(y);t!==null&&D(t),M(!1)},it=async()=>{if(!u.length)return;M(!0),j("");const t=[];for(let a=0;a<u.length;a++){const c=await G(u[a]);t.push(`=== Trang ${a+1} ===
${c??"[Lỗi OCR trang này]"}`)}const e=t.join(`

`+"=".repeat(50)+`

`),r=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(r),o=document.createElement("a");o.href=n,o.download="ocr-extracted-text.txt",o.click(),URL.revokeObjectURL(n),M(!1)};return s.jsxs("div",{className:"w-full h-full",children:[s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[1fr_2fr_1.5fr] gap-4",children:[s.jsxs("div",{children:[s.jsxs("div",{onDragOver:t=>t.preventDefault(),onDrop:t=>{t.preventDefault(),V(t.dataTransfer.files)},className:`mb-3 ${z} border-dashed p-6 text-center hover:border-cyan-500 min-h-[240px] flex flex-col items-center justify-center`,children:[s.jsx("div",{className:"text-4xl",children:"📄"}),s.jsx("div",{className:"text-sm opacity-80 mt-1",children:"Kéo thả file Ảnh hoặc PDF vào đây"}),s.jsx("button",{className:"mt-3 rounded-lg bg-cyan-600 px-4 py-2 text-sm font-semibold text-white hover:bg-cyan-700",onClick:()=>q.current?.click(),children:"Chọn file"}),s.jsx("input",{ref:q,type:"file",accept:".pdf,.jpg,.jpeg,.png,.webp",multiple:!0,className:"hidden",onChange:t=>V(t.target.files)})]}),s.jsx("div",{className:"text-xs opacity-70",children:u.length?`${u.length} trang/ảnh đã tải lên`:"Chưa có ảnh/trang nào"}),s.jsx("button",{onClick:tt,className:"mt-2 rounded-lg bg-rose-600 px-3 py-1 text-xs font-semibold text-white hover:bg-rose-700",children:"Reset"})]}),s.jsx("div",{children:s.jsxs("div",{className:`${z} p-3`,children:[s.jsxs("div",{ref:m,onWheel:ot,onDoubleClick:rt,onMouseDown:t=>{!$||t.button!==0||R&&(t.target===g.current||t.target.closest(".border-2"))||(I(!0),F.current={x:t.clientX-W.x,y:t.clientY-W.y},t.preventDefault())},onMouseMove:t=>{!Q||!$||N({x:t.clientX-F.current.x,y:t.clientY-F.current.y})},onMouseUp:()=>I(!1),onMouseLeave:()=>I(!1),className:"relative flex items-center justify-center h-[330px] overflow-hidden rounded-xl bg-zinc-50 cursor-grab active:cursor-grabbing",children:[y?s.jsx("img",{ref:A,src:y.dataUrl,className:"absolute top-0 left-0 max-w-none max-h-none select-none",style:{transform:`translate(${W.x}px, ${W.y}px) scale(${L})`,transformOrigin:"0 0"},alt:"preview",draggable:!1}):s.jsx("div",{className:"flex items-center justify-center text-sm text-zinc-500",children:"Chưa có ảnh/trang nào"}),y&&s.jsxs("div",{className:"absolute right-2 top-2 flex gap-1",children:[s.jsx("button",{onClick:R?at:nt,className:`rounded-md px-3 py-1.5 text-xs font-semibold text-white shadow ${R?"bg-rose-600 hover:bg-rose-700":"bg-zinc-600 hover:bg-zinc-700"}`,children:R?"Hủy":"Crop"}),R&&s.jsx("button",{onClick:st,className:"rounded-md bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white shadow hover:bg-emerald-700",children:"Xác nhận"})]}),R&&s.jsx("div",{ref:g,className:"absolute border-2 border-dashed border-emerald-500 bg-emerald-300/10",style:{left:40,top:40,width:260,height:180},children:s.jsx("div",{"data-role":"resize",className:"absolute -right-2 -bottom-2 h-4 w-4 cursor-se-resize rounded-full bg-emerald-500"})})]}),s.jsx("div",{className:"mt-3 flex gap-3 overflow-x-auto pb-2",children:u.map((t,e)=>s.jsxs("div",{className:`relative w-[110px] flex-shrink-0 rounded-lg border p-1 ${e===f?"border-cyan-500 ring-2 ring-cyan-200":"border-transparent"}`,children:[s.jsx("img",{src:t.dataUrl,className:"h-[86px] w-full cursor-pointer rounded object-cover",onClick:()=>x(e)}),s.jsx("button",{onClick:()=>{v(r=>{const n=[...r];return n.splice(e,1),f===e?x(n.length?Math.min(e,n.length-1):-1):f>e&&x(o=>o-1),n})},className:"absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-rose-600 text-xs font-semibold text-white shadow",title:"Xóa trang",children:"×"}),s.jsxs("div",{className:"mt-1 text-center text-[11px] opacity-70",children:["Trang ",e+1]})]},t.id))})]})}),s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:`${z} flex-1 p-3`,children:s.jsx("textarea",{className:"h-[220px] w-full h-full rounded-xl border border-zinc-300 p-2 font-mono text-sm !text-black",value:X,onChange:t=>D(t.target.value)})}),s.jsxs("div",{className:`${z} mt-4 p-3`,children:[s.jsxs("div",{className:"grid grid-cols-1 gap-2 sm:grid-cols-2",children:[s.jsx("button",{disabled:!$||C,onClick:ct,className:"rounded-lg bg-cyan-600 px-3 py-2 text-sm font-semibold text-white hover:bg-cyan-700 disabled:opacity-60",children:C?"Đang xử lý…":"Đọc trang hiện tại"}),s.jsx("button",{disabled:!u.length||C,onClick:it,className:"rounded-lg bg-zinc-800 px-3 py-2 text-sm font-semibold text-white hover:bg-black disabled:opacity-60",children:"Đọc toàn bộ trang & xuất file"})]}),s.jsxs("label",{className:"mt-3 flex items-center gap-2 text-xs opacity-80",children:[s.jsx("input",{type:"checkbox",className:"size-4 accent-cyan-500",checked:E,onChange:t=>P(t.target.checked)}),"Tự động nén ảnh trước khi OCR (≤ 1MB)"]})]})]})]}),w&&s.jsx("div",{className:`${z} mt-4 border-rose-300 bg-rose-50 px-3 py-2 text-sm text-rose-700`,children:w})]})}export{pt as default};
