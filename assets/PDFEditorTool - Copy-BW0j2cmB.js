import{r as c,j as a}from"./index-BHruAiqV.js";import{g as ke,G as De}from"./pdf-DQXiXaQD.js";import{E as Me}from"./jspdf.es.min-J4ze2ZdL.js";import"./_commonjsHelpers-Cpj98o6Y.js";De.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";function Se(){const U=c.useRef(null),I=c.useRef(null),j=c.useRef(null),X=c.useRef(null),[x,k]=c.useState([]),[b,E]=c.useState(0),[ie,ee]=c.useState(!1),[de,te]=c.useState(0),[he,ne]=c.useState(""),[ue,F]=c.useState(!1),[D,ae]=c.useState("all"),[P,H]=c.useState({from:1,to:1}),[z,B]=c.useState(1),[T,C]=c.useState({x:0,y:0}),[se,G]=c.useState(1),[_,K]=c.useState({x:0,y:0}),[ge,A]=c.useState(!1),[Y,re]=c.useState({width:0,height:0}),J=c.useRef({x:0,y:0}),v=(e,t="info")=>{const s=document.getElementById("status-container");if(!s)return;s.innerHTML="";const n=document.createElement("div");n.className="p-3 rounded-lg mb-2 font-medium max-w-sm "+(t==="success"?"bg-green-100 text-green-800 border border-green-300":t==="error"?"bg-red-100 text-red-800 border border-red-300":t==="warning"?"bg-yellow-100 text-yellow-800 border border-yellow-300":"bg-blue-100 text-blue-800 border border-blue-300"),n.textContent=e,s.appendChild(n),t==="success"&&setTimeout(()=>s.contains(n)&&s.removeChild(n),4e3)},N=c.useCallback((e,t,s)=>{const n=document.createElement("canvas"),r=n.getContext("2d"),o=Math.min(t/e.width,s/e.height),i=Math.max(1,Math.round(e.width*o)),g=Math.max(1,Math.round(e.height*o));return n.width=i,n.height=g,r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",r.drawImage(e,0,0,i,g),n},[]),me=c.useCallback(e=>{e.preventDefault(),I.current?.classList.add("ring","ring-cyan-400")},[]),xe=c.useCallback(()=>{I.current?.classList.remove("ring","ring-cyan-400")},[]),pe=c.useCallback(e=>{e.preventDefault(),I.current?.classList.remove("ring","ring-cyan-400");const t=Array.from(e.dataTransfer.files);oe(t)},[]),fe=c.useCallback(e=>{const t=Array.from(e.target.files||[]);oe(t),U.current&&(U.current.value="")},[]),oe=c.useCallback(async e=>{const t=e.filter(r=>r.type==="application/pdf"||["image/jpeg","image/jpg","image/png"].includes(r.type));if(!t.length){v("Vui lòng chọn file PDF/JPG/PNG hợp lệ","error");return}t.length>50&&t.splice(50),ee(!0),te(0),ne("Đang tải file…");let s=x.length;const n=[];for(let r=0;r<t.length;r++){const o=t[r];te((r+1)/t.length*100),ne(`Đang xử lý: ${o.name} (${r+1}/${t.length})`);try{if(o.type==="application/pdf"){const i=await o.arrayBuffer(),g=await ke(i).promise;for(let m=1;m<=g.numPages;m++){const p=await g.getPage(m),d=p.getViewport({scale:2}),l=document.createElement("canvas"),h=l.getContext("2d");l.width=d.width,l.height=d.height,await p.render({canvasContext:h,viewport:d,canvas:l}).promise;const u=N(l,60,80);n.push({id:`page_${s}_${Date.now()}`,originalFile:o,pageNumber:m,canvas:l,thumbnailCanvas:u,dataUrl:l.toDataURL("image/jpeg",.9),thumbnailDataUrl:u.toDataURL("image/jpeg",.85),rotation:0,index:s,type:"pdf"}),s++}}else{const i=await new Promise(g=>{const m=new FileReader;m.onload=p=>{const d=new Image;d.onload=()=>{const l=document.createElement("canvas"),h=l.getContext("2d");l.width=d.width,l.height=d.height,h.drawImage(d,0,0);const u=N(l,60,80);g({id:`page_${s}_${Date.now()}`,originalFile:o,canvas:l,thumbnailCanvas:u,dataUrl:l.toDataURL("image/jpeg",.9),thumbnailDataUrl:u.toDataURL("image/jpeg",.85),rotation:0,index:s,type:"image"})},d.src=String(p.target?.result||"")},m.readAsDataURL(o)});n.push(i),s++}}catch(i){console.error(i),v(`Lỗi xử lý file ${o.name}: ${i?.message||"Không xác định"}`,"error")}}k(r=>{const o=[...r,...n];return!r.length&&o.length&&E(0),o}),ee(!1),H({from:1,to:x.length+n.length}),v(`Đã thêm ${n.length} trang. Tổng ${x.length+n.length} trang.`,"success")},[x.length,N]),le=c.useCallback((e,t)=>{k(s=>{const n=e+t;if(n<0||n>=s.length)return s;const r=[...s],o=r[e];return r[e]=r[n],r[n]=o,r.forEach((i,g)=>i.index=g),E(i=>i===e?n:i===n?e:i),r})},[]),ce=c.useCallback((e,t)=>{const s=t*Math.PI/180,n=Math.abs(Math.sin(s)),r=Math.abs(Math.cos(s)),o=document.createElement("canvas"),i=o.getContext("2d");return o.width=e.width*r+e.height*n,o.height=e.width*n+e.height*r,i.translate(o.width/2,o.height/2),i.rotate(s),i.drawImage(e,-e.width/2,-e.height/2),o},[]),be=c.useCallback(e=>{k(t=>{const s=[...t],n={...s[e]};return n.rotation=(n.rotation+90)%360,n.canvas=ce(t[e].canvas,90),n.dataUrl=n.canvas.toDataURL("image/jpeg",.9),n.thumbnailCanvas=N(n.canvas,60,80),n.thumbnailDataUrl=n.thumbnailCanvas.toDataURL("image/jpeg",.85),s[e]=n,s}),v("Đã xoay trang","success")},[ce,N]),ye=c.useCallback(e=>{confirm("Xóa trang này?")&&k(t=>{const s=t.slice(0,e).concat(t.slice(e+1));return E(n=>Math.min(n,Math.max(0,s.length-1))),s})},[]),[M,V]=c.useState(!1),W=c.useRef(null),R=c.useRef({x:0,y:0}),Z=c.useRef({dx:0,dy:0}),S=c.useRef(null),$=c.useRef(!1),L=c.useRef(!1),we=e=>{const t=(s,n,r)=>{const o=document.createElement("div");o.dataset.handle=s,o.className="absolute w-3 h-3 bg-cyan-500 border-2 border-white rounded-full z-30",Object.assign(o.style,n,{cursor:r}),e.appendChild(o)};t("nw",{left:"0%",top:"0%",transform:"translate(-50%, -50%)"},"nwse-resize"),t("ne",{left:"100%",top:"0%",transform:"translate(-50%, -50%)"},"nesw-resize"),t("sw",{left:"0%",top:"100%",transform:"translate(-50%, -50%)"},"nesw-resize"),t("se",{left:"100%",top:"100%",transform:"translate(-50%, -50%)"},"nwse-resize"),t("n",{left:"50%",top:"0%",transform:"translate(-50%, -50%)"},"ns-resize"),t("s",{left:"50%",top:"100%",transform:"translate(-50%, -50%)"},"ns-resize"),t("w",{left:"0%",top:"50%",transform:"translate(-50%, -50%)"},"ew-resize"),t("e",{left:"100%",top:"50%",transform:"translate(-50%, -50%)"},"ew-resize")},ve=c.useCallback(()=>{const e=j.current,t=X.current;if(!e||!t)return;V(!0),document.body.style.userSelect="none";const s=document.createElement("div");s.id="crop-overlay",s.className="absolute inset-0 z-10",s.style.pointerEvents="none";const n=document.createElement("div");n.id="crop-frame",n.className="absolute border-2 border-cyan-500 bg-cyan-500/10 cursor-move z-20 rounded",n.style.pointerEvents="auto",e.appendChild(s),s.appendChild(n),W.current=n,we(n);const r=t.getBoundingClientRect(),o=e.getBoundingClientRect(),i=Math.max(50,r.width*.5),g=Math.max(50,r.height*.5),m=r.left-o.left+(r.width-i)/2,p=r.top-o.top+(r.height-g)/2;n.style.left=`${m}px`,n.style.top=`${p}px`,n.style.width=`${i}px`,n.style.height=`${g}px`,n.addEventListener("mousedown",d=>{if(d.target.closest("[data-handle]"))return;L.current=!1,$.current=!0;const h=n.getBoundingClientRect();Z.current={dx:d.clientX-h.left,dy:d.clientY-h.top},d.preventDefault()}),n.querySelectorAll("[data-handle]").forEach(d=>d.addEventListener("mousedown",l=>{$.current=!1,L.current=!0,S.current=l.target.dataset.handle,R.current.x=l.clientX,R.current.y=l.clientY,l.preventDefault(),l.stopPropagation()}))},[]),q=c.useCallback(e=>{if(!M)return;const t=W.current,s=X.current,n=j.current;if(!t||!s||!n)return;const r=s.getBoundingClientRect(),o=n.getBoundingClientRect(),i=r.left-o.left,g=r.top-o.top,m=i+r.width,p=g+r.height,d=t.getBoundingClientRect();if($.current){let l=e.clientX-o.left-Z.current.dx,h=e.clientY-o.top-Z.current.dy;const u=d.width,f=d.height;l=Math.max(i,Math.min(l,m-u)),h=Math.max(g,Math.min(h,p-f)),t.style.left=`${l}px`,t.style.top=`${h}px`}if(L.current&&S.current){const l=e.clientX-R.current.x,h=e.clientY-R.current.y;let u=d.left-o.left,f=d.top-o.top,y=d.width,w=d.height;switch(S.current){case"nw":u+=l,f+=h,y-=l,w-=h;break;case"ne":f+=h,y+=l,w-=h;break;case"sw":u+=l,y-=l,w+=h;break;case"se":y+=l,w+=h;break;case"n":f+=h,w-=h;break;case"s":w+=h;break;case"w":u+=l,y-=l;break;case"e":y+=l;break}y=Math.max(50,y),w=Math.max(50,w),u=Math.max(i,Math.min(u,m-y)),f=Math.max(g,Math.min(f,p-w)),u+y>m&&(y=m-u),f+w>p&&(w=p-f),t.style.left=`${u}px`,t.style.top=`${f}px`,t.style.width=`${y}px`,t.style.height=`${w}px`,R.current.x=e.clientX,R.current.y=e.clientY}},[M]),Q=c.useCallback(()=>{$.current=!1,L.current=!1,S.current=null,document.body.style.userSelect=""},[]);c.useEffect(()=>{if(M)return document.addEventListener("mousemove",q),document.addEventListener("mouseup",Q),()=>{document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",Q)}},[M,q,Q]);const O=c.useCallback(()=>{V(!1);const e=document.getElementById("crop-overlay");e?.parentElement?.removeChild(e),W.current=null,$.current=!1,L.current=!1,S.current=null,document.body.style.userSelect=""},[]),je=c.useCallback(()=>{const e=W.current,t=X.current;if(!e||!t)return;const s=e.getBoundingClientRect(),n=t.getBoundingClientRect(),r=t.naturalWidth/n.width,o=t.naturalHeight/n.height,i=(s.left-n.left)*r,g=(s.top-n.top)*o,m=s.width*r,p=s.height*o;k(d=>{const l=[...d],h={...l[b]},u=document.createElement("canvas"),f=u.getContext("2d");return u.width=Math.max(1,Math.round(m)),u.height=Math.max(1,Math.round(p)),f.drawImage(h.canvas,i,g,m,p,0,0,u.width,u.height),h.canvas=u,h.dataUrl=u.toDataURL("image/jpeg",.9),h.thumbnailCanvas=N(u,60,80),h.thumbnailDataUrl=h.thumbnailCanvas.toDataURL("image/jpeg",.85),l[b]=h,l}),O(),v("Đã cắt ảnh","success")},[b,O,N]);c.useEffect(()=>{M&&O()},[b]),c.useEffect(()=>{const e=x[b];if(!e||!j.current){G(1),B(1),K({x:0,y:0}),C({x:0,y:0}),re({width:0,height:0});return}const t=j.current,s=t.clientWidth,n=t.clientHeight,r=new Image;r.onload=()=>{const o=r.naturalWidth,i=r.naturalHeight;re({width:o,height:i});const g=s/o,m=n/i,p=Math.min(g,m,1),d=o*p,l=i*p,h=(s-d)/2,u=(n-l)/2;G(p),B(p),K({x:h,y:u}),C({x:h,y:u})},r.src=e.dataUrl},[b,x]),c.useEffect(()=>{if(!Y.width||z<=se){C(_);return}const e=j.current?.clientWidth||0,t=j.current?.clientHeight||0,s=Y.width*z,n=Y.height*z,r=0,o=e-s,i=0,g=t-n;C(m=>({x:Math.min(r,Math.max(o,m.x)),y:Math.min(i,Math.max(g,m.y))}))},[z,Y,_]);const Ce=()=>{B(se),C(_)},Ne=c.useCallback(async()=>{if(!x.length){v("Không có trang để xuất PDF","error");return}const e=D==="range"?Math.max(1,Math.min(P.from,x.length)):1,t=D==="range"?Math.max(e,Math.min(P.to,x.length)):x.length,s=x.slice(e-1,t);try{const n=new Me;s.forEach((o,i)=>{i>0&&n.addPage();const g=210,m=297,p=o.canvas.width/o.canvas.height;let d,l;p>g/m?(d=g-20,l=d/p):(l=m-20,d=l*p);const h=(g-d)/2,u=(m-l)/2,f=o.canvas.toDataURL("image/jpeg",.9);n.addImage(f,"JPEG",h,u,d,l)});const r=new Date().toISOString().slice(0,10).replace(/-/g,"");n.save(`edited_pdf_${r}.pdf`),v("Đã xuất PDF","success"),F(!1)}catch(n){console.error(n),v(`Lỗi tạo PDF: ${n?.message||"Không xác định"}`,"error")}},[x,D,P]);return a.jsxs("div",{className:"w-full h-full overflow-hidden",children:[a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[1fr_2fr] gap-4 h-[calc(100%-1.5rem)]",children:[a.jsxs("div",{className:"min-w-0 overflow-auto lg:overflow-hidden flex flex-col",children:[a.jsxs("div",{ref:I,className:"mb-3 mt-1 border-2 border-dashed border-cyan-500 rounded-xl p-8 text-center bg-slate-400/30 backdrop-blur transition-all duration-300 hover:border-cyan-600 hover:bg-green-50/50",onDragOver:me,onDragLeave:xe,onDrop:pe,onClick:()=>U.current?.click(),children:[a.jsx("div",{className:"text-4xl mb-4 text-cyan-500",children:"📄"}),a.jsx("div",{className:"text-lg text-white mb-2",children:"Kéo thả file PDF/Ảnh vào đây hoặc bấm để chọn"}),a.jsx("div",{className:"text-sm text-white-300 mb-4",children:"Hỗ trợ: PDF, JPG, PNG, JPEG (tối đa 50 file)"}),a.jsx("button",{className:"bg-cyan-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-cyan-600 transition-colors",children:"Chọn file để chỉnh sửa"}),a.jsx("input",{ref:U,type:"file",accept:".pdf,.jpg,.jpeg,.png",multiple:!0,className:"hidden",onChange:fe})]}),ie&&a.jsxs("div",{className:"ml-2 mr-2 p-4 border border-zinc-300 rounded-xl bg-zinc-50",children:[a.jsx("h3",{className:"text-lg font-medium mb-2",children:"Đang xử lý file..."}),a.jsx("div",{className:"bg-zinc-200 rounded-full h-2 mb-2",children:a.jsx("div",{className:"bg-gradient-to-r from-cyan-500 to-green-500 h-2 rounded-full transition-all duration-300",style:{width:`${de}%`}})}),a.jsx("p",{className:"text-sm text-zinc-600",children:he})]}),a.jsx("div",{id:"status-container",className:"ml-2 mr-2"}),a.jsxs("div",{className:"mt-3 flex flex-wrap items-center justify-center gap-2 mb-2",children:[a.jsx("button",{onClick:()=>{k([]),E(0),V(!1);const e=document.getElementById("crop-overlay");e?.parentElement?.removeChild(e),B(1),C({x:0,y:0}),G(1),K({x:0,y:0})},className:"rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-700 disabled:opacity-50",disabled:!x.length,children:"🔄 Reset"}),a.jsx("button",{onClick:()=>{H({from:1,to:x.length||1}),F(!0)},className:"rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-lg hover:shadow-xl disabled:opacity-50",disabled:!x.length,children:"📥 Xuất PDF"})]})]}),a.jsx("div",{className:"min-w-0 mr-1 overflow-hidden",children:a.jsxs("div",{className:"flex h-full gap-3",children:[a.jsx("div",{ref:j,onDoubleClick:Ce,onMouseDown:e=>{!x[b]||e.button!==0||e.target.closest("#crop-frame")||(A(!0),J.current={x:e.clientX-T.x,y:e.clientY-T.y},e.preventDefault())},onMouseMove:e=>{!ge||!x[b]||C({x:e.clientX-J.current.x,y:e.clientY-J.current.y})},onMouseUp:()=>A(!1),onMouseLeave:()=>A(!1),className:"relative flex-1 border border-zinc-300 rounded-xl bg-slate-400/30 backdrop-blur-sm overflow-hidden cursor-grab active:cursor-grabbing",children:x.length?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"absolute top-2 right-2 z-30 flex gap-2",children:M?a.jsxs(a.Fragment,{children:[a.jsx("button",{onClick:je,className:"rounded bg-emerald-600 text-white text-xs px-3 py-1 hover:bg-emerald-700",children:"Áp dụng"}),a.jsx("button",{onClick:O,className:"rounded bg-rose-600 text-white text-xs px-3 py-1 hover:bg-rose-700",children:"Hủy"})]}):a.jsx("button",{onClick:ve,className:"rounded bg-cyan-600 text-white text-xs px-3 py-1 hover:bg-cyan-700",children:"Crop"})}),a.jsx("img",{ref:X,src:x[b].dataUrl,alt:`Preview trang ${b+1}`,className:"absolute top-0 left-0 max-w-none max-h-none select-none",style:{transform:`translate(${T.x}px, ${T.y}px) scale(${z})`,transformOrigin:"0 0"},draggable:!1},x[b].id)]}):a.jsx("div",{className:"flex items-center justify-center h-full text-center text-white",children:a.jsxs("div",{children:[a.jsx("div",{className:"text-4xl mb-2",children:"📄"}),a.jsx("p",{children:"Chưa có trang nào"})]})})}),a.jsxs("div",{className:"w-56 border border-zinc-300 rounded-xl bg-slate-400/30 backdrop-blur-sm overflow-hidden flex flex-col",children:[a.jsx("div",{className:"px-3 py-2 text-sm font-medium text-center",children:"📑 Danh sách trang"}),a.jsx("div",{className:"flex-1 overflow-y-auto p-2 flex flex-col gap-2",children:x.length===0?a.jsxs("div",{className:"flex-1 flex items-center justify-center text-center text-xs text-white py-4",children:["Không có trang nào ",a.jsx("br",{}),"Upload file để bắt đầu"]}):x.map((e,t)=>a.jsxs("div",{className:`relative bg-white rounded-lg px-2 py-2 cursor-pointer transition-all duration-300 border ${t===b?"border-cyan-500 ring-2 ring-cyan-500/20 shadow":"border-zinc-200 hover:shadow"}`,onClick:()=>E(t),children:[a.jsxs("div",{className:"absolute top-1 right-1 flex gap-1",children:[a.jsx("button",{className:"w-5 h-5 bg-zinc-500 text-white rounded-full text-[10px] leading-[18px] hover:bg-zinc-600 disabled:opacity-40",title:"Lên",disabled:t===0,onClick:s=>{s.stopPropagation(),le(t,-1)},children:"↑"}),a.jsx("button",{className:"w-5 h-5 bg-zinc-500 text-white rounded-full text-[10px] leading-[18px] hover:bg-zinc-600 disabled:opacity-40",title:"Xuống",disabled:t===x.length-1,onClick:s=>{s.stopPropagation(),le(t,1)},children:"↓"}),a.jsx("button",{className:"w-5 h-5 bg-gray-500 text-white rounded-full text-[10px] leading-[18px] hover:bg-gray-600",title:"Xoay",onClick:s=>{s.stopPropagation(),be(t)},children:"↻"}),a.jsx("button",{className:"w-5 h-5 bg-red-500 text-white rounded-full text-[12px] leading-[18px] hover:bg-red-600",title:"Xóa",onClick:s=>{s.stopPropagation(),ye(t)},children:"×"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("img",{src:e.thumbnailDataUrl,alt:`Thumb ${t+1}`,className:"w-[30px] h-[40px] object-contain bg-white border border-zinc-200 rounded"}),a.jsxs("div",{className:"text-xs text-zinc-600",children:["Trang ",t+1]})]})]},e.id))})]})]})})]}),ue&&a.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsx("h3",{className:"text-lg font-semibold",children:"📥 Xuất PDF"}),a.jsx("button",{onClick:()=>F(!1),className:"text-2xl text-zinc-500 hover:text-zinc-700",children:"×"})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("label",{className:"flex items-center gap-2 p-2 rounded border cursor-pointer hover:bg-gray-50",children:[a.jsx("input",{type:"radio",name:"export-type",value:"all",checked:D==="all",onChange:()=>ae("all")}),a.jsx("span",{children:"📄 Xuất tất cả trang"})]}),a.jsxs("label",{className:"flex items-center gap-2 p-2 rounded border cursor-pointer hover:bg-gray-50",children:[a.jsx("input",{type:"radio",name:"export-type",value:"range",checked:D==="range",onChange:()=>ae("range")}),a.jsx("span",{children:"📑 Chọn khoảng trang"})]}),D==="range"&&a.jsxs("div",{className:"ml-6 space-y-2",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-sm",children:"Từ trang"}),a.jsx("input",{type:"number",min:1,max:x.length,value:P.from,onChange:e=>H(t=>({...t,from:+e.target.value})),className:"w-16 p-2 border rounded text-center"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-sm",children:"đến trang"}),a.jsx("input",{type:"number",min:1,max:x.length,value:P.to,onChange:e=>H(t=>({...t,to:+e.target.value})),className:"w-16 p-2 border rounded text-center"})]})]})]}),a.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[a.jsx("button",{onClick:()=>F(!1),className:"px-4 py-2 border rounded-lg text-zinc-600 hover:bg-zinc-50",children:"Hủy"}),a.jsx("button",{onClick:Ne,className:"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600",children:"Xuất PDF"})]})]})})]})}export{Se as default};
