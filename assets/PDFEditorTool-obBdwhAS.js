import{r as c,j as a}from"./index-B_g4B3LB.js";import{g as ke,G as De}from"./pdf-DQXiXaQD.js";import{E as Me}from"./jspdf.es.min-CqKKv2Bs.js";import"./_commonjsHelpers-Cpj98o6Y.js";De.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";function Se(){const X=c.useRef(null),F=c.useRef(null),j=c.useRef(null),H=c.useRef(null),[g,k]=c.useState([]),[f,R]=c.useState(0),[ie,te]=c.useState(!1),[de,ne]=c.useState(0),[he,ae]=c.useState(""),[ue,B]=c.useState(!1),[D,re]=c.useState("all"),[P,T]=c.useState({from:1,to:1}),[z,S]=c.useState(1),[Y,C]=c.useState({x:0,y:0}),[$,_]=c.useState(1),[K,A]=c.useState({x:0,y:0}),[ge,J]=c.useState(!1),[W,se]=c.useState({width:0,height:0}),V=c.useRef({x:0,y:0}),y=(e,t="info")=>{const r=document.getElementById("status-container");if(!r)return;r.innerHTML="";const n=document.createElement("div");n.className="p-3 rounded-lg mb-2 font-medium max-w-sm "+(t==="success"?"bg-green-100 text-green-800 border border-green-300":t==="error"?"bg-red-100 text-red-800 border border-red-300":t==="warning"?"bg-yellow-100 text-yellow-800 border border-yellow-300":"bg-blue-100 text-blue-800 border border-blue-300"),n.textContent=e,r.appendChild(n),t==="success"&&setTimeout(()=>r.contains(n)&&r.removeChild(n),4e3)},N=c.useCallback((e,t,r)=>{const n=document.createElement("canvas"),s=n.getContext("2d"),o=Math.min(t/e.width,r/e.height),i=Math.max(1,Math.round(e.width*o)),m=Math.max(1,Math.round(e.height*o));return n.width=i,n.height=m,s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(e,0,0,i,m),n},[]),me=c.useCallback(e=>{e.preventDefault(),F.current?.classList.add("ring","ring-cyan-400")},[]),xe=c.useCallback(()=>{F.current?.classList.remove("ring","ring-cyan-400")},[]),pe=c.useCallback(e=>{e.preventDefault(),F.current?.classList.remove("ring","ring-cyan-400");const t=Array.from(e.dataTransfer.files);oe(t)},[]),fe=c.useCallback(e=>{const t=Array.from(e.target.files||[]);oe(t),X.current&&(X.current.value="")},[]),oe=c.useCallback(async e=>{const t=e.filter(s=>s.type==="application/pdf"||["image/jpeg","image/jpg","image/png"].includes(s.type));if(!t.length){y("Vui lòng chọn file PDF/JPG/PNG hợp lệ","error");return}t.length>50&&t.splice(50),te(!0),ne(0),ae("Đang tải file…");let r=g.length;const n=[];for(let s=0;s<t.length;s++){const o=t[s];ne((s+1)/t.length*100),ae(`Đang xử lý: ${o.name} (${s+1}/${t.length})`);try{if(o.type==="application/pdf"){const i=await o.arrayBuffer(),m=await ke(i).promise;for(let x=1;x<=m.numPages;x++){const p=await m.getPage(x),d=p.getViewport({scale:2}),l=document.createElement("canvas"),h=l.getContext("2d");l.width=d.width,l.height=d.height,await p.render({canvasContext:h,viewport:d,canvas:l}).promise;const u=N(l,60,80);n.push({id:`page_${r}_${Date.now()}`,originalFile:o,pageNumber:x,canvas:l,thumbnailCanvas:u,dataUrl:l.toDataURL("image/jpeg",.9),thumbnailDataUrl:u.toDataURL("image/jpeg",.85),rotation:0,index:r,type:"pdf"}),r++}}else{const i=await new Promise(m=>{const x=new FileReader;x.onload=p=>{const d=new Image;d.onload=()=>{const l=document.createElement("canvas"),h=l.getContext("2d");l.width=d.width,l.height=d.height,h.drawImage(d,0,0);const u=N(l,60,80);m({id:`page_${r}_${Date.now()}`,originalFile:o,canvas:l,thumbnailCanvas:u,dataUrl:l.toDataURL("image/jpeg",.9),thumbnailDataUrl:u.toDataURL("image/jpeg",.85),rotation:0,index:r,type:"image"})},d.src=String(p.target?.result||"")},x.readAsDataURL(o)});n.push(i),r++}}catch(i){console.error(i),y(`Lỗi xử lý file ${o.name}: ${i?.message||"Không xác định"}`,"error")}}k(s=>{const o=[...s,...n];return!s.length&&o.length&&R(0),o}),te(!1),T({from:1,to:g.length+n.length}),y(`Đã thêm ${n.length} trang. Tổng ${g.length+n.length} trang.`,"success")},[g.length,N]),le=c.useCallback((e,t)=>{k(r=>{const n=e+t;if(n<0||n>=r.length)return r;const s=[...r],o=s[e];return s[e]=s[n],s[n]=o,s.forEach((i,m)=>i.index=m),R(i=>i===e?n:i===n?e:i),s})},[]),ce=c.useCallback((e,t)=>{const r=t*Math.PI/180,n=Math.abs(Math.sin(r)),s=Math.abs(Math.cos(r)),o=document.createElement("canvas"),i=o.getContext("2d");return o.width=e.width*s+e.height*n,o.height=e.width*n+e.height*s,i.translate(o.width/2,o.height/2),i.rotate(r),i.drawImage(e,-e.width/2,-e.height/2),o},[]),be=c.useCallback(e=>{k(t=>{const r=[...t],n={...r[e]};return n.rotation=(n.rotation+90)%360,n.canvas=ce(t[e].canvas,90),n.dataUrl=n.canvas.toDataURL("image/jpeg",.9),n.thumbnailCanvas=N(n.canvas,60,80),n.thumbnailDataUrl=n.thumbnailCanvas.toDataURL("image/jpeg",.85),r[e]=n,r}),y("Đã xoay trang","success")},[ce,N]),we=c.useCallback(e=>{confirm("Xóa trang này?")&&k(t=>{const r=t.slice(0,e).concat(t.slice(e+1));return R(n=>Math.min(n,Math.max(0,r.length-1))),r})},[]),[M,Z]=c.useState(!1),O=c.useRef(null),E=c.useRef({x:0,y:0}),q=c.useRef({dx:0,dy:0}),L=c.useRef(null),U=c.useRef(!1),I=c.useRef(!1),ve=e=>{const t=(r,n,s)=>{const o=document.createElement("div");o.dataset.handle=r,o.className="absolute w-3 h-3 bg-cyan-500 border-2 border-white rounded-full z-30",Object.assign(o.style,n,{cursor:s}),e.appendChild(o)};t("nw",{left:"0%",top:"0%",transform:"translate(-50%, -50%)"},"nwse-resize"),t("ne",{left:"100%",top:"0%",transform:"translate(-50%, -50%)"},"nesw-resize"),t("sw",{left:"0%",top:"100%",transform:"translate(-50%, -50%)"},"nesw-resize"),t("se",{left:"100%",top:"100%",transform:"translate(-50%, -50%)"},"nwse-resize"),t("n",{left:"50%",top:"0%",transform:"translate(-50%, -50%)"},"ns-resize"),t("s",{left:"50%",top:"100%",transform:"translate(-50%, -50%)"},"ns-resize"),t("w",{left:"0%",top:"50%",transform:"translate(-50%, -50%)"},"ew-resize"),t("e",{left:"100%",top:"50%",transform:"translate(-50%, -50%)"},"ew-resize")},ye=c.useCallback(()=>{const e=j.current,t=H.current;if(!e||!t)return;Z(!0),document.body.style.userSelect="none";const r=document.createElement("div");r.id="crop-overlay",r.className="absolute inset-0 z-10",r.style.pointerEvents="none";const n=document.createElement("div");n.id="crop-frame",n.className="absolute border-2 border-cyan-500 bg-cyan-500/10 cursor-move z-20 rounded",n.style.pointerEvents="auto",e.appendChild(r),r.appendChild(n),O.current=n,ve(n);const s=t.getBoundingClientRect(),o=e.getBoundingClientRect(),i=Math.max(50,s.width*.5),m=Math.max(50,s.height*.5),x=s.left-o.left+(s.width-i)/2,p=s.top-o.top+(s.height-m)/2;n.style.left=`${x}px`,n.style.top=`${p}px`,n.style.width=`${i}px`,n.style.height=`${m}px`,n.addEventListener("mousedown",d=>{if(d.target.closest("[data-handle]"))return;I.current=!1,U.current=!0;const h=n.getBoundingClientRect();q.current={dx:d.clientX-h.left,dy:d.clientY-h.top},d.preventDefault()}),n.querySelectorAll("[data-handle]").forEach(d=>d.addEventListener("mousedown",l=>{U.current=!1,I.current=!0,L.current=l.target.dataset.handle,E.current.x=l.clientX,E.current.y=l.clientY,l.preventDefault(),l.stopPropagation()}))},[]),Q=c.useCallback(e=>{if(!M)return;const t=O.current,r=H.current,n=j.current;if(!t||!r||!n)return;const s=r.getBoundingClientRect(),o=n.getBoundingClientRect(),i=s.left-o.left,m=s.top-o.top,x=i+s.width,p=m+s.height,d=t.getBoundingClientRect();if(U.current){let l=e.clientX-o.left-q.current.dx,h=e.clientY-o.top-q.current.dy;const u=d.width,b=d.height;l=Math.max(i,Math.min(l,x-u)),h=Math.max(m,Math.min(h,p-b)),t.style.left=`${l}px`,t.style.top=`${h}px`}if(I.current&&L.current){const l=e.clientX-E.current.x,h=e.clientY-E.current.y;let u=d.left-o.left,b=d.top-o.top,w=d.width,v=d.height;switch(L.current){case"nw":u+=l,b+=h,w-=l,v-=h;break;case"ne":b+=h,w+=l,v-=h;break;case"sw":u+=l,w-=l,v+=h;break;case"se":w+=l,v+=h;break;case"n":b+=h,v-=h;break;case"s":v+=h;break;case"w":u+=l,w-=l;break;case"e":w+=l;break}w=Math.max(50,w),v=Math.max(50,v),u=Math.max(i,Math.min(u,x-w)),b=Math.max(m,Math.min(b,p-v)),u+w>x&&(w=x-u),b+v>p&&(v=p-b),t.style.left=`${u}px`,t.style.top=`${b}px`,t.style.width=`${w}px`,t.style.height=`${v}px`,E.current.x=e.clientX,E.current.y=e.clientY}},[M]),ee=c.useCallback(()=>{U.current=!1,I.current=!1,L.current=null,document.body.style.userSelect=""},[]);c.useEffect(()=>{if(M)return document.addEventListener("mousemove",Q),document.addEventListener("mouseup",ee),()=>{document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",ee)}},[M,Q,ee]);const G=c.useCallback(()=>{Z(!1);const e=document.getElementById("crop-overlay");e?.parentElement?.removeChild(e),O.current=null,U.current=!1,I.current=!1,L.current=null,document.body.style.userSelect=""},[]),je=c.useCallback(()=>{const e=O.current,t=H.current;if(!e||!t)return;const r=e.getBoundingClientRect(),n=t.getBoundingClientRect(),s=t.naturalWidth/n.width,o=t.naturalHeight/n.height,i=(r.left-n.left)*s,m=(r.top-n.top)*o,x=r.width*s,p=r.height*o;k(d=>{const l=[...d],h={...l[f]},u=document.createElement("canvas"),b=u.getContext("2d");return u.width=Math.max(1,Math.round(x)),u.height=Math.max(1,Math.round(p)),b.drawImage(h.canvas,i,m,x,p,0,0,u.width,u.height),h.canvas=u,h.dataUrl=u.toDataURL("image/jpeg",.9),h.thumbnailCanvas=N(u,60,80),h.thumbnailDataUrl=h.thumbnailCanvas.toDataURL("image/jpeg",.85),l[f]=h,l}),G(),y("Đã cắt ảnh","success")},[f,G,N]);c.useEffect(()=>{M&&G()},[f]),c.useEffect(()=>{const e=g[f];if(!e||!j.current){_(1),S(1),A({x:0,y:0}),C({x:0,y:0}),se({width:0,height:0});return}const t=j.current,r=t.clientWidth,n=t.clientHeight,s=new Image;s.onload=()=>{const o=s.naturalWidth,i=s.naturalHeight;se({width:o,height:i});const m=r/o,x=n/i,p=Math.min(m,x,1),d=o*p,l=i*p,h=(r-d)/2,u=(n-l)/2;_(p),S(p),A({x:h,y:u}),C({x:h,y:u})},s.src=e.dataUrl},[f,g]),c.useEffect(()=>{if(!W.width||z<=$){C(K);return}const e=j.current?.clientWidth||0,t=j.current?.clientHeight||0,r=W.width*z,n=W.height*z,s=0,o=e-r,i=0,m=t-n;C(x=>({x:Math.min(s,Math.max(o,x.x)),y:Math.min(i,Math.max(m,x.y))}))},[z,W,K]);const Ce=()=>{S($),C(K)};c.useEffect(()=>{const e=j.current;if(!e)return;const t=r=>{if(r.preventDefault(),!g[f])return;const n=-r.deltaY;S(s=>{const o=Math.max($,Math.min(4,s+(n>0?.1:-.1)));return Number(o.toFixed(2))})};return e.addEventListener("wheel",t,{passive:!1}),()=>e.removeEventListener("wheel",t)},[$,g,f]);const Ne=c.useCallback(async()=>{if(!g.length){y("Không có trang để xuất PDF","error");return}const e=D==="range"?Math.max(1,Math.min(P.from,g.length)):1,t=D==="range"?Math.max(e,Math.min(P.to,g.length)):g.length,r=g.slice(e-1,t).filter(Boolean);if(!r.length){y("Không có trang hợp lệ để xuất.","error");return}try{const n=new Me({unit:"mm",format:"a4",orientation:"portrait"});r.forEach((o,i)=>{i>0&&n.addPage("a4","portrait");const m=210,x=297,p=o.canvas.width/o.canvas.height;let d,l;p>m/x?(d=m-20,l=d/p):(l=x-20,d=l*p);const h=(m-d)/2,u=(x-l)/2,b=o.canvas.toDataURL("image/jpeg",.9);n.addImage(b,"JPEG",h,u,d,l)});const s=new Date().toISOString().slice(0,10).replace(/-/g,"");n.save(`edited_pdf_${s}.pdf`),y("Đã xuất PDF","success"),B(!1)}catch(n){console.error(n),y(`Lỗi tạo PDF: ${n?.message||"Không xác định"}`,"error")}},[g,D,P,$]);return a.jsxs("div",{className:"w-full h-full overflow-hidden",children:[a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[1fr_2fr] gap-4 h-[calc(100%-1.5rem)]",children:[a.jsxs("div",{className:"min-w-0 overflow-auto lg:overflow-hidden flex flex-col",children:[a.jsxs("div",{ref:F,className:"mb-3 mt-1 border-2 border-dashed border-cyan-500 rounded-xl p-8 text-center bg-slate-400/30 backdrop-blur transition-all duration-300 hover:border-cyan-600 hover:bg-green-50/50",onDragOver:me,onDragLeave:xe,onDrop:pe,onClick:()=>X.current?.click(),children:[a.jsx("div",{className:"text-4xl mb-4 text-cyan-500",children:"📄"}),a.jsx("div",{className:"text-lg text-white mb-2",children:"Kéo thả file PDF/Ảnh vào đây hoặc bấm để chọn"}),a.jsx("div",{className:"text-sm text-white-300 mb-4",children:"Hỗ trợ: PDF, JPG, PNG, JPEG (tối đa 50 file)"}),a.jsx("button",{className:"bg-cyan-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-cyan-600 transition-colors",children:"Chọn file để chỉnh sửa"}),a.jsx("input",{ref:X,type:"file",accept:".pdf,.jpg,.jpeg,.png",multiple:!0,className:"hidden",onChange:fe})]}),ie&&a.jsxs("div",{className:"ml-2 mr-2 p-4 border border-zinc-300 rounded-xl bg-zinc-50",children:[a.jsx("h3",{className:"text-lg font-medium mb-2",children:"Đang xử lý file..."}),a.jsx("div",{className:"bg-zinc-200 rounded-full h-2 mb-2",children:a.jsx("div",{className:"bg-gradient-to-r from-cyan-500 to-green-500 h-2 rounded-full transition-all duration-300",style:{width:`${de}%`}})}),a.jsx("p",{className:"text-sm text-zinc-600",children:he})]}),a.jsx("div",{id:"status-container",className:"ml-2 mr-2"}),a.jsxs("div",{className:"mt-3 flex flex-wrap items-center justify-center gap-2 mb-2",children:[a.jsx("button",{onClick:()=>{k([]),R(0),Z(!1);const e=document.getElementById("crop-overlay");e?.parentElement?.removeChild(e),S(1),C({x:0,y:0}),_(1),A({x:0,y:0})},className:"rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-700 disabled:opacity-50",disabled:!g.length,children:"🔄 Reset"}),a.jsx("button",{onClick:()=>{T({from:1,to:g.length||1}),B(!0)},className:"rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-lg hover:shadow-xl disabled:opacity-50",disabled:!g.length,children:"📥 Xuất PDF"})]})]}),a.jsx("div",{className:"min-w-0 mr-1 overflow-hidden",children:a.jsxs("div",{className:"flex h-full gap-3",children:[a.jsx("div",{ref:j,onDoubleClick:Ce,onMouseDown:e=>{!g[f]||e.button!==0||e.target.closest("#crop-frame")||(J(!0),V.current={x:e.clientX-Y.x,y:e.clientY-Y.y},e.preventDefault())},onMouseMove:e=>{!ge||!g[f]||C({x:e.clientX-V.current.x,y:e.clientY-V.current.y})},onMouseUp:()=>J(!1),onMouseLeave:()=>J(!1),className:"relative flex-1 border border-zinc-300 rounded-xl bg-slate-400/30 backdrop-blur-sm overflow-hidden cursor-grab active:cursor-grabbing",children:g.length?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"absolute top-2 right-2 z-30 flex gap-2",children:M?a.jsxs(a.Fragment,{children:[a.jsx("button",{onClick:je,className:"rounded bg-emerald-600 text-white text-xs px-3 py-1 hover:bg-emerald-700",children:"Áp dụng"}),a.jsx("button",{onClick:G,className:"rounded bg-rose-600 text-white text-xs px-3 py-1 hover:bg-rose-700",children:"Hủy"})]}):a.jsx("button",{onClick:ye,className:"rounded bg-cyan-600 text-white text-xs px-3 py-1 hover:bg-cyan-700",children:"Crop"})}),a.jsx("img",{ref:H,src:g[f].dataUrl,alt:`Preview trang ${f+1}`,className:"absolute top-0 left-0 max-w-none max-h-none select-none",style:{transform:`translate(${Y.x}px, ${Y.y}px) scale(${z})`,transformOrigin:"0 0"},draggable:!1},g[f].id)]}):a.jsx("div",{className:"flex items-center justify-center h-full text-center text-white",children:a.jsxs("div",{children:[a.jsx("div",{className:"text-4xl mb-2",children:"📄"}),a.jsx("p",{children:"Chưa có trang nào"})]})})}),a.jsxs("div",{className:"w-56 border border-zinc-300 rounded-xl bg-slate-400/30 backdrop-blur-sm overflow-hidden flex flex-col",children:[a.jsx("div",{className:"px-3 py-2 text-sm font-medium text-center",children:"Danh sách trang"}),a.jsx("div",{className:"flex-1 overflow-y-auto p-2 flex flex-col gap-2",children:g.length===0?a.jsxs("div",{className:"flex-1 flex items-center justify-center text-center text-xs text-white py-4",children:["Không có trang nào ",a.jsx("br",{}),"Upload file để bắt đầu"]}):g.map((e,t)=>a.jsxs("div",{className:`relative bg-white rounded-lg px-2 py-2 cursor-pointer transition-all duration-300 border ${t===f?"border-cyan-500 ring-2 ring-cyan-500/20 shadow":"border-zinc-200 hover:shadow"}`,onClick:()=>R(t),children:[a.jsxs("div",{className:"absolute top-1 right-1 flex gap-1",children:[a.jsx("button",{className:"w-5 h-5 bg-zinc-500 text-white rounded-full text-[10px] leading-[18px] hover:bg-zinc-600 disabled:opacity-40",title:"Lên",disabled:t===0,onClick:r=>{r.stopPropagation(),le(t,-1)},children:"↑"}),a.jsx("button",{className:"w-5 h-5 bg-zinc-500 text-white rounded-full text-[10px] leading-[18px] hover:bg-zinc-600 disabled:opacity-40",title:"Xuống",disabled:t===g.length-1,onClick:r=>{r.stopPropagation(),le(t,1)},children:"↓"}),a.jsx("button",{className:"w-5 h-5 bg-gray-500 text-white rounded-full text-[10px] leading-[18px] hover:bg-gray-600",title:"Xoay",onClick:r=>{r.stopPropagation(),be(t)},children:"↻"}),a.jsx("button",{className:"w-5 h-5 bg-red-500 text-white rounded-full text-[12px] leading-[18px] hover:bg-red-600",title:"Xóa",onClick:r=>{r.stopPropagation(),we(t)},children:"×"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("img",{src:e.thumbnailDataUrl,alt:`Thumb ${t+1}`,className:"w-[30px] h-[40px] object-contain bg-white border border-zinc-200 rounded"}),a.jsxs("div",{className:"text-xs text-zinc-600",children:["Trang ",t+1]})]})]},e.id))})]})]})})]}),ue&&a.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsx("h3",{className:"text-lg font-semibold",children:"📥 Xuất PDF"}),a.jsx("button",{onClick:()=>B(!1),className:"text-2xl text-zinc-500 hover:text-zinc-700",children:"×"})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("label",{className:"flex items-center gap-2 p-2 rounded border cursor-pointer hover:bg-gray-50",children:[a.jsx("input",{type:"radio",name:"export-type",value:"all",checked:D==="all",onChange:()=>re("all")}),a.jsx("span",{children:"📄 Xuất tất cả trang"})]}),a.jsxs("label",{className:"flex items-center gap-2 p-2 rounded border cursor-pointer hover:bg-gray-50",children:[a.jsx("input",{type:"radio",name:"export-type",value:"range",checked:D==="range",onChange:()=>re("range")}),a.jsx("span",{children:"📑 Chọn khoảng trang"})]}),D==="range"&&a.jsxs("div",{className:"ml-6 space-y-2",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-sm",children:"Từ trang"}),a.jsx("input",{type:"number",min:1,max:g.length,value:P.from,onChange:e=>T(t=>({...t,from:+e.target.value})),className:"w-16 p-2 border rounded text-center"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-sm",children:"đến trang"}),a.jsx("input",{type:"number",min:1,max:g.length,value:P.to,onChange:e=>T(t=>({...t,to:+e.target.value})),className:"w-16 p-2 border rounded text-center"})]})]})]}),a.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[a.jsx("button",{onClick:()=>B(!1),className:"px-4 py-2 border rounded-lg text-zinc-600 hover:bg-zinc-50",children:"Hủy"}),a.jsx("button",{onClick:Ne,className:"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600",children:"Xuất PDF"})]})]})})]})}export{Se as default};
