import{r as o,R as G,j as t}from"./index-DKdO3KDO.js";import"./_commonjsHelpers-Cpj98o6Y.js";const R="rounded-2xl border border-zinc-200/80 bg-white/70 shadow-sm backdrop-blur dark:bg-zinc-900/60 dark:border-zinc-700";function z(v){for(const u of v)if(window.MediaRecorder&&MediaRecorder.isTypeSupported&&MediaRecorder.isTypeSupported(u))return u}function Y(){const v=o.useRef(null),u=o.useRef(null),[n,T]=o.useState(null),[r,S]=o.useState(""),[J,E]=o.useState(null),[N,f]=o.useState(!1),[F,w]=o.useState(0),[K,j]=o.useState("Đang khởi tạo…"),[D,m]=o.useState("Vui lòng chọn file video để bắt đầu."),[h,U]=o.useState(""),[k,C]=o.useState(""),[g,M]=o.useState(""),[L,O]=o.useState(""),H=()=>v.current?.click(),$=()=>{h&&URL.revokeObjectURL(h),g&&URL.revokeObjectURL(g),U(""),M("")};o.useEffect(()=>()=>$(),[]),o.useEffect(()=>()=>{r&&URL.revokeObjectURL(r)},[r]);const W=G.useCallback(()=>{r&&URL.revokeObjectURL(r),h&&URL.revokeObjectURL(h),g&&URL.revokeObjectURL(g),u.current&&(u.current.pause(),u.current.removeAttribute("src"),u.current.load()),v.current&&(v.current.value=""),T(null),S(""),E(null),f(!1),w(0),j("Đang khởi tạo…"),m("Vui lòng chọn file video để bắt đầu."),U(""),C(""),M(""),O("")},[r,h,g]),q=async e=>{if(!e||!e.length)return;const s=e[0];if(!s.type.startsWith("video/")){m("File không phải video.");return}if(s.size>100*1024*1024){m("File quá lớn! Vui lòng chọn file nhỏ hơn 100MB.");return}$(),T(s);const d=URL.createObjectURL(s);S(d),m(`Đã chọn: ${s.name} (${(s.size/1024/1024).toFixed(2)} MB)`)};o.useEffect(()=>{const e=u.current;!e||!r||(e.src=r,e.onloadedmetadata=()=>{E({width:e.videoWidth,height:e.videoHeight,duration:e.duration})})},[r]);const A=(e="Đang khởi tạo…")=>{f(!0),w(0),j(e)},a=(e,s)=>{w(Math.max(0,Math.min(100,e))),s&&j(s)},P=(e="Hoàn tất!")=>{w(100),j(e),setTimeout(()=>f(!1),300)},_=o.useCallback(async()=>{if(n)try{A("Đang tách audio…");const e=document.createElement("video");e.src=URL.createObjectURL(n),e.crossOrigin="anonymous",a(10,"Đang tải video…"),await new Promise((i,l)=>{e.onloadedmetadata=()=>i(),e.onerror=()=>l(new Error("Không tải được metadata video")),setTimeout(()=>l(new Error("Timeout tải video")),15e3)}),a(25,"Đang khởi tạo AudioContext…");const s=window.AudioContext||window.webkitAudioContext,d=new s;d.state==="suspended"&&await d.resume();const b=d.createMediaElementSource(e),y=d.createMediaStreamDestination();b.connect(y);const c=z(["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg","audio/mp4"])||"",p=new MediaRecorder(y.stream,c?{mimeType:c}:void 0),x=[];p.ondataavailable=i=>i.data&&x.push(i.data),p.onerror=i=>{console.error(i)},p.onstop=()=>{a(95,"Đang tạo file audio…");const i=new Blob(x,{type:c||"application/octet-stream"}),l=URL.createObjectURL(i);U(l),C(c||"application/octet-stream"),P(),m("Tách audio hoàn tất!")},a(35,"Bắt đầu ghi âm…"),p.start(800),e.ontimeupdate=()=>{if(e.duration>0){const i=35+e.currentTime/e.duration*55;a(i,`Đang xử lý… ${Math.round(e.currentTime)}s/${Math.round(e.duration)}s`)}},a(40,"Đang phát video để ghi âm…"),await e.play(),e.onended=()=>{a(90,"Kết thúc ghi âm…"),p.stop(),d.close()}}catch(e){console.error(e),f(!1),m("Lỗi khi tách audio: "+(e?.message||"Không xác định"))}},[n]),I=o.useCallback(async()=>{if(n)try{A("Đang tạo video không tiếng…");const e=document.createElement("video");e.src=URL.createObjectURL(n),e.muted=!0,e.crossOrigin="anonymous",a(10,"Đang tải video…"),await new Promise((i,l)=>{e.onloadedmetadata=()=>i(),e.onerror=()=>l(new Error("Không tải được metadata video")),setTimeout(()=>l(new Error("Timeout tải video")),15e3)}),a(25,"Đang tạo canvas…");const s=document.createElement("canvas");s.width=e.videoWidth,s.height=e.videoHeight;const d=s.getContext("2d"),b=z(["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm","video/mp4;codecs=h264","video/mp4"])||"",y=s.captureStream(30),c=new MediaRecorder(y,b?{mimeType:b,videoBitsPerSecond:25e5}:void 0),p=[];c.ondataavailable=i=>i.data&&p.push(i.data),c.onstop=()=>{a(95,"Đang tạo file video…");const i=new Blob(p,{type:b||"application/octet-stream"}),l=URL.createObjectURL(i);M(l),O(b||"application/octet-stream"),P(),m("Tạo video không tiếng hoàn tất!")},a(40,"Bắt đầu ghi video…"),c.start(800),e.ontimeupdate=()=>{if(e.duration>0){const i=40+e.currentTime/e.duration*50;a(i,`Đang xử lý… ${Math.round(e.currentTime)}s/${Math.round(e.duration)}s`)}};const x=()=>{!e.paused&&!e.ended&&(d.drawImage(e,0,0,s.width,s.height),requestAnimationFrame(x))};e.onplay=x,await e.play(),e.onended=()=>{a(90,"Kết thúc ghi video…"),c.stop()}}catch(e){console.error(e),f(!1),m("Lỗi khi tạo video không tiếng: "+(e?.message||"Không xác định"))}},[n]),B=o.useMemo(()=>{const e=n?.name?.replace(/\.[^.]+$/,"")||"audio";return k.includes("webm")?e+".webm":k.includes("ogg")?e+".ogg":k.includes("mp4")?e+".m4a":e+".bin"},[n?.name,k]),V=o.useMemo(()=>{const e=n?.name?.replace(/\.[^.]+$/,"")||"video_muted";return L.includes("webm")?e+".webm":L.includes("mp4")?e+".mp4":e+".bin"},[n?.name,L]);return t.jsx("div",{className:"w-full h-full overflow-hidden",children:t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[1.2fr_1.8fr] gap-4 h-[calc(100%-2rem)]",children:[t.jsxs("div",{className:"min-w-0 overflow-auto lg:overflow-hidden flex flex-col gap-3",children:[t.jsx("div",{className:`${R} p-4`,children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:H,className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700",children:"Chọn video"}),n&&t.jsx("span",{className:"text-xs opacity-70",children:n.name}),t.jsx("input",{ref:v,type:"file",accept:"video/*",className:"hidden",onChange:e=>q(e.target.files)})]})}),t.jsxs("div",{className:`${R} p-4`,children:[t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsx("button",{disabled:!n||N,onClick:_,className:"rounded-lg bg-cyan-600 px-4 py-2 text-sm font-semibold text-white hover:bg-cyan-700 disabled:opacity-60",children:"Tách Audio"}),t.jsx("button",{disabled:!n||N,onClick:I,className:"rounded-lg bg-zinc-800 px-4 py-2 text-sm font-semibold text-white hover:bg-black disabled:opacity-60",children:"Tách Video (không tiếng)"})]}),N&&t.jsxs("div",{className:"mt-4",children:[t.jsx("div",{className:"h-2 w-full rounded-full bg-zinc-200 dark:bg-zinc-700 overflow-hidden",children:t.jsx("div",{className:"h-full bg-indigo-500 transition-all",style:{width:`${F}%`}})}),t.jsx("div",{className:"mt-2 text-xs opacity-75",children:K})]}),t.jsx("div",{className:"mt-3 text-sm opacity-80",children:D})]}),h&&t.jsxs("div",{className:`${R} p-4`,children:[t.jsx("div",{className:"font-medium mb-2",children:"Preview Audio"}),t.jsx("audio",{controls:!0,className:"w-full",src:h}),t.jsxs("a",{href:h,download:B,className:"mt-2 inline-block rounded-lg bg-emerald-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-emerald-700",children:["Tải ",B]})]}),t.jsx("button",{type:"button",onClick:W,className:"rounded-lg bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-700 disabled:opacity-60",children:"Reset"})]}),g&&t.jsxs("div",{className:`${R} p-4`,children:[t.jsx("div",{className:"font-medium mb-2",children:"Preview Video (không tiếng)"}),t.jsx("div",{className:"relative w-full aspect-video rounded-lg overflow-hidden bg-black/70",children:t.jsx("video",{controls:!0,src:g,className:"absolute inset-0 h-full w-full object-contain"})}),t.jsxs("a",{href:g,download:V,className:"mt-2 inline-block rounded-lg bg-emerald-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-emerald-700",children:["Tải ",V]})]})]})})}export{Y as default};
