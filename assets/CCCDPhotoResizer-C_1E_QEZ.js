import{r as l,j as t}from"./index-BXMMG8vt.js";import"./_commonjsHelpers-Cpj98o6Y.js";const v="border border-zinc-300/40 bg-white/40 backdrop-blur-xl rounded-2xl shadow-lg dark:bg-zinc-800/40 dark:border-zinc-700/40";function re(){const[y,T]=l.useState(null),[x,D]=l.useState(""),[j,H]=l.useState(null),[N,B]=l.useState(!1),[C,K]=l.useState(!1),[p,k]=l.useState("cccd"),[M,R]=l.useState(null),[f,a]=l.useState(null),[S,w]=l.useState(!1),F=l.useRef(null),E=l.useRef(null),b=l.useRef(null);l.useEffect(()=>{(async()=>{try{if(a({message:"ƒêang t·∫£i th∆∞ vi·ªán TensorFlow.js...",type:"warning"}),window.tf||await new Promise((n,r)=>{const s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js",s.onload=()=>n(),s.onerror=()=>r(new Error("Failed to load TensorFlow.js")),document.head.appendChild(s)}),window.blazeface||await new Promise((n,r)=>{const s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js",s.onload=()=>n(),s.onerror=()=>r(new Error("Failed to load BlazeFace")),document.head.appendChild(s)}),await new Promise(n=>setTimeout(n,500)),a({message:"ƒêang t·∫£i m√¥ h√¨nh nh·∫≠n di·ªán khu√¥n m·∫∑t...",type:"warning"}),window.blazeface){const n=await window.blazeface.load();R(n),a({message:"ƒê√£ t·∫£i xong m√¥ h√¨nh nh·∫≠n di·ªán khu√¥n m·∫∑t",type:"success"})}else throw new Error("BlazeFace not available after loading")}catch(n){console.error("Error loading face detection model:",n),a({message:"Kh√¥ng th·ªÉ t·∫£i m√¥ h√¨nh nh·∫≠n di·ªán khu√¥n m·∫∑t. S·∫Ω s·ª≠ d·ª•ng ch·∫ø ƒë·ªô x·ª≠ l√Ω th√¥ng th∆∞·ªùng.",type:"warning"}),R(null)}})()},[]);const z=e=>{if(!e.type.startsWith("image/")||!["image/jpeg","image/jpg","image/png"].includes(e.type)){a({message:"ƒê·ªãnh d·∫°ng file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. Vui l√≤ng ch·ªçn file JPG, JPEG ho·∫∑c PNG.",type:"error"});return}if(e.size>5*1024*1024){a({message:"File qu√° l·ªõn. Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.",type:"error"});return}T(e);const n=new FileReader;n.onload=r=>{D(r.target?.result),B(!0),a({message:"ƒê√£ nh·∫≠n ·∫£nh - s·∫µn s√†ng x·ª≠ l√Ω!",type:"success"})},n.readAsDataURL(e)},U=e=>{e.preventDefault(),e.currentTarget.classList.add("dragover")},W=e=>{e.currentTarget.classList.remove("dragover")},L=e=>{e.preventDefault(),e.currentTarget.classList.remove("dragover");const n=Array.from(e.dataTransfer.files);n.length>0&&z(n[0])},$=()=>{F.current?.click()},O=async()=>{if(!y){a({message:"Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc khi x·ª≠ l√Ω.",type:"error"});return}w(!0),a({message:"ƒêang ph√¢n t√≠ch ·∫£nh...",type:"warning"});try{const e=new Image;e.onload=async()=>{try{let n=!1,r=null;if(M){const h=await M.estimateFaces(e,!1);h.length>0&&(n=!0,r=h[0].boundingBox,a({message:"ƒê√£ ph√°t hi·ªán khu√¥n m·∫∑t - ƒëang cƒÉn ch·ªânh...",type:"success"}))}n||a({message:"Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c khu√¥n m·∫∑t r√µ r√†ng. S·∫Ω x·ª≠ l√Ω ·∫£nh theo c√°ch th√¥ng th∆∞·ªùng.",type:"warning"});const s=X(p),i=(await Y(e,{faceBox:r,photoType:s})).toDataURL("image/jpeg",1);H(i),E.current&&(E.current.src=x),b.current&&(b.current.src=i),K(!0),a({message:"X·ª≠ l√Ω ·∫£nh ho√†n t·∫•t! B·∫°n c√≥ th·ªÉ t·∫£i ·∫£nh v·ªÅ b√™n d∆∞·ªõi.",type:"success"}),document.getElementById("result-section")?.scrollIntoView({behavior:"smooth"})}catch(n){console.error("Error processing image:",n),a({message:"C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ·∫£nh: "+n.message,type:"error"})}finally{w(!1)}},e.onerror=()=>{a({message:"Kh√¥ng th·ªÉ t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.",type:"error"}),w(!1)},e.src=x}catch(e){console.error("Error in processImage:",e),a({message:"C√≥ l·ªói x·∫£y ra: "+e.message,type:"error"}),w(!1)}},V=()=>{if(!j){a({message:"Kh√¥ng c√≥ ·∫£nh ƒë·ªÉ t·∫£i. Vui l√≤ng x·ª≠ l√Ω ·∫£nh tr∆∞·ªõc.",type:"error"});return}const e=new Date().toISOString().slice(0,10).replace(/-/g,""),r=`${{cccd:"cccd",passport:"passport"}[p]}_photo_${e}.jpg`,s=document.createElement("a");s.href=j,s.download=r,document.body.appendChild(s),s.click(),document.body.removeChild(s),a({message:`ƒê√£ t·∫£i ·∫£nh v·ªÅ v·ªõi t√™n: ${r}`,type:"success"})},X=e=>{switch(e){case"cccd":return{width:354,height:472,faceHeightRatio:.625,topMargin:30,bottomMargin:45};case"passport":return{width:472,height:709,faceHeightRatio:.675,topMargin:40,bottomMargin:70};default:return{width:354,height:472,faceHeightRatio:.625,topMargin:30,bottomMargin:45}}},Y=async(e,n)=>{const{faceBox:r,photoType:s}=n,c=document.createElement("canvas"),i=c.getContext("2d");c.width=s.width,c.height=s.height,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high";let o;if(r?o=G(e,r,s):o=A(e,s),Math.min(s.width/o.sw,s.height/o.sh)<.5){const u=document.createElement("canvas"),d=u.getContext("2d"),g=s.width*2,m=s.height*2;u.width=g,u.height=m,d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.drawImage(e,o.sx,o.sy,o.sw,o.sh,0,0,g,m),i.drawImage(u,0,0,g,m,0,0,s.width,s.height)}else i.drawImage(e,o.sx,o.sy,o.sw,o.sh,0,0,c.width,c.height);return c},G=(e,n,r)=>{const[s,c,i,o]=n,h=s+i/2,d=r.height*r.faceHeightRatio/o,g=r.width/d,m=r.height/d,J=h-g/2,Q=r.topMargin/d,_=c-Q,I=Math.max(0,Math.min(J,e.width-g)),P=Math.max(0,Math.min(_,e.height-m)),Z=Math.min(g,e.width-I),ee=Math.min(m,e.height-P);return{sx:I,sy:P,sw:Z,sh:ee,scaleFactor:d}},A=(e,n)=>{const r=n.width/n.height,s=e.width/e.height;let c,i;s>r?(i=e.height,c=i*r):(c=e.width,i=c/r);const o=(e.width-c)/2,h=(e.height-i)/2;return{sx:o,sy:h,sw:c,sh:i,scaleFactor:Math.min(n.width/c,n.height/i)}},q=()=>{a(null)};return t.jsx("div",{className:"w-full h-full p-4 text-zinc-800 dark:text-zinc-200 overflow-hidden",children:t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-4 h-[calc(100%-2rem)]",children:[t.jsxs("div",{className:`${v} col-span-1 flex flex-col p-2 gap-2`,children:[t.jsxs("div",{className:"flex-grow flex flex-col justify-between gap-2",children:[t.jsxs("div",{className:"border-2 border-dashed border-green-500 rounded-lg p-3 text-center bg-green-50/50 transition-all duration-300 cursor-pointer hover:border-green-600 hover:bg-green-50/70 dark:bg-green-900/20 mb-1",onDragOver:U,onDragLeave:W,onDrop:L,onClick:$,children:[t.jsx("div",{className:"text-2xl mb-1",children:"üì∑"}),t.jsx("div",{className:"text-xs font-medium mb-1",children:"K√©o th·∫£ ho·∫∑c click"}),t.jsx("div",{className:"text-xs text-zinc-500 mb-2",children:"JPG, PNG (‚â§5MB)"}),t.jsx("button",{className:"bg-green-500 text-white px-3 py-1.5 rounded-md font-medium text-xs hover:bg-green-600 transition-colors w-full",children:"Ch·ªçn ·∫£nh"}),t.jsx("input",{ref:F,type:"file",className:"hidden",accept:".jpg,.jpeg,.png",onChange:e=>e.target.files&&z(e.target.files[0])})]}),f&&t.jsxs("div",{className:`p-1.5 rounded-md text-xs ${f.type==="success"?"bg-green-100 text-green-800 border border-green-300":f.type==="error"?"bg-red-100 text-red-800 border border-red-300":"bg-yellow-100 text-yellow-800 border border-yellow-300"}`,children:[f.message,t.jsx("button",{onClick:q,className:"float-right text-xs",children:"√ó"})]})]}),N&&t.jsxs("div",{className:"bg-white/20 rounded-lg p-2",children:[t.jsx("h3",{className:"text-xs font-semibold text-center mb-1",children:"üìê K√≠ch th∆∞·ªõc"}),t.jsxs("div",{className:"space-y-1",children:[t.jsxs("label",{className:"flex items-center gap-1.5 text-xs",children:[t.jsx("input",{type:"radio",name:"photo-type",value:"cccd",checked:p==="cccd",onChange:e=>k(e.target.value),className:"w-3 h-3 text-green-600"}),t.jsx("span",{children:"üìÑ CCCD"})]}),t.jsxs("label",{className:"flex items-center gap-1.5 text-xs",children:[t.jsx("input",{type:"radio",name:"photo-type",value:"passport",checked:p==="passport",onChange:e=>k(e.target.value),className:"w-3 h-3 text-green-600"}),t.jsx("span",{children:"üõÇ H·ªô chi·∫øu"})]})]})]})]}),t.jsxs("div",{className:`${v} col-span-2 flex flex-col p-2 gap-2`,children:[t.jsx("div",{className:"flex-1 flex items-center justify-center rounded-lg border-2 border-zinc-300 p-1",children:x?t.jsx("img",{src:x,alt:"Preview",className:"max-w-full max-h-96 rounded-lg shadow-md"},"preview"):t.jsxs("div",{className:"text-center text-white",children:[t.jsx("div",{className:"text-3xl mb-1",children:"üñºÔ∏è"}),t.jsx("div",{className:"text-xs",children:"Preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y"})]})}),N&&t.jsx("div",{className:"text-center",children:t.jsx("button",{onClick:O,disabled:S||!y,className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2.5 rounded-lg font-semibold text-sm shadow-lg hover:from-green-600 hover:to-green-700 transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none w-full",children:S?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"inline-block w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin mr-1.5"}),"ƒêang x·ª≠ l√Ω..."]}):"‚úÇÔ∏è C·∫Øt v√† ch·ªânh k√≠ch th∆∞·ªõc"})})]}),t.jsxs("div",{className:`${v} col-span-2 flex flex-col p-2 gap-2`,children:[t.jsx("div",{className:"flex justify-center",children:t.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded-full text-white",children:"K·∫øt qu·∫£"})}),t.jsx("div",{className:"flex-1 flex items-center justify-center rounded-lg border-2 border-zinc-300 p-1",children:C?t.jsxs("div",{className:"text-center w-full",children:[t.jsx("img",{ref:b,alt:"·∫¢nh ƒë√£ x·ª≠ l√Ω",className:"max-w-full max-h-80 rounded-lg shadow-md mx-auto mb-1"},"result"),t.jsxs("div",{className:"text-xs text-white",children:["·∫¢nh ƒë√£ x·ª≠ l√Ω (",p.toUpperCase(),")"]})]}):t.jsxs("div",{className:"text-center text-white",children:[t.jsx("div",{className:"text-3xl mb-1",children:"‚ú®"}),t.jsx("div",{className:"text-xs",children:"K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y"})]})}),C&&t.jsx("div",{className:"text-center",children:t.jsx("button",{onClick:V,className:"bg-green-500 text-white px-4 py-2.5 rounded-lg font-semibold text-sm shadow-lg hover:bg-green-600 transform hover:scale-105 transition-all duration-200 w-full",children:"üì• T·∫£i ·∫£nh v·ªÅ"})})]})]})})}export{re as default};
